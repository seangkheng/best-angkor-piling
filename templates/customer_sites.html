{% extends "base.html" %}

{% block title %}Manage Customers & Sites | គ្រប់គ្រងអតិថិជន & ការដ្ឋាន{% endblock %}

{% block content %}
<h1>Manage Customers & Sites | គ្រប់គ្រងអតិថិជន & ការដ្ឋាន</h1>

<div class="button-group">
    {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
        <a href="{{ url_for('add_customer_site') }}" class="add-button"><i class="fas fa-plus-circle"></i> បន្ថែមអតិថិជន/ការដ្ឋានថ្មី | Add New Customer/Site</a>
    {% endif %}
    <button class="export-btn" onclick="exportTableToExcel('customer-sites-table', 'customer_sites_report')"><i class="fas fa-file-excel"></i> នាំចេញទៅ Excel | Export to Excel</button>
    <button class="export-btn" onclick="exportTableToPDF('customer-sites-table', 'Customer Sites Report')"><i class="fas fa-file-pdf"></i> នាំចេញទៅ PDF | នាំចេញទៅ PDF</button>
</div>

<table id="customer-sites-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Customer/Site Name | ឈ្មោះអតិថិជន/ការដ្ឋាន</th>
            <th>Address | អាសយដ្ឋាន</th>
            <th>Phone | លេខទូរស័ព្ទ</th>
            <th>Created At | បង្កើតនៅថ្ងៃ</th>
            <th>Actions | សកម្មភាព</th>
        </tr>
    </thead>
    <tbody>
        {% for site in customer_sites %}
        <tr>
            <td data-label="ID">{{ site.id }}</td>
            <td data-label="Customer/Site Name | ឈ្មោះអតិថិជន/ការដ្ឋាន">{{ site.name }}</td>
            <td data-label="Address | អាសយដ្ឋាន">{{ site.address if site.address is not none else 'N/A' }}</td>
            <td data-label="Phone | លេខទូរស័ព្ទ">{{ site.phone if site.phone is not none else 'N/A' }}</td>
            <td data-label="Created At | បង្កើតនៅថ្ងៃ">{{ site.created_at.strftime('%Y-%m-%d %H:%M:%S') if site.created_at else 'N/A' }}</td>
            <td data-label="Actions | សកម្មភាព" class="actions">
                {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
                    <a href="{{ url_for('edit_customer_site', site_id=site.id) }}" class="edit-button"><i class="fas fa-edit"></i> កែសម្រួល</a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                    <form method="POST" action="{{ url_for('delete_customer_site', site_id=site.id) }}" onsubmit="event.preventDefault(); showModal('Are you sure you want to delete this customer site? This action cannot be undone and may fail if there are associated transactions! | ប្រាកដទេថាចង់លុបការដ្ឋានអតិថិជននេះ? សកម្មភាពនេះមិនអាចផ្លាស់ប្ដូរវិញបានទេ ហើយអាចនឹងបរាជ័យប្រសិនបើមានប្រតិបត្តិការពាក់ព័ន្ធ!', 'confirm', 'Confirm Deletion | បញ្ជាក់ការលុប', function(result) { if (result) this.closest('form').submit(); }.bind(this));">
                        <button type="submit" class="delete-button"><i class="fas fa-trash-alt"></i> លុប</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6">No customer sites found. | រកមិនឃើញការដ្ឋានអតិថិជនទេ។</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
    // Export functions are now in base.html, so no need to define them here.
    // Just ensure the onclick calls are correct.
</script>
{% endblock %}
