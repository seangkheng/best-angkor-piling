{% extends "base.html" %}

{% block title %}Edit Pile - Best Angkor Piling App{% endblock %}

{% block content %}
<h2>Edit Pile: {{ pile.sku }} | កែសម្រួលសសរ: {{ pile.sku }}</h2>
<form method="POST" action="{{ url_for('edit_pile', pile_id=pile.id) }}">
    <label for="pile_type">Pile Type | ប្រភេទសសរ:</label>
    <input type="text" id="pile_type" name="pile_type" value="{{ pile.pile_type }}" required>

    <label for="size">Size | ទំហំ:</label>
    <input type="text" id="size" name="size" value="{{ pile.size }}" required>

    <label for="length">Length (m) | ប្រវែង (ម៉ែត្រ):</label>
    <input type="number" id="length" name="length" step="0.01" value="{{ '%.2f'|format(pile.length) }}" required>

    <label for="sku">SKU | លេខកូដ:</label>
    <input type="text" id="sku" name="sku" value="{{ pile.sku }}" required>

    <label for="current_stock">Current Stock | ស្តុកបច្ចុប្បន្ន:</label>
    <input type="number" id="current_stock" name="current_stock" value="{{ pile.current_stock }}" disabled>
    <small style="color: gray;">(Stock is updated via transactions, not directly editable here | ស្តុកត្រូវបានធ្វើបច្ចុប្បន្នភាពតាមរយៈប្រតិបត្តិការ មិនអាចកែសម្រួលដោយផ្ទាល់នៅទីនេះទេ)</small>

    <label for="unit_price">Unit Price | តម្លៃឯកតា:</label>
    <input type="number" id="unit_price" name="unit_price" step="0.01" value="{{ '%.2f'|format(pile.unit_price) }}" required>

    <label for="description">Description | ការពិពណ៌នា:</label>
    <textarea id="description" name="description" rows="3">{{ pile.description or '' }}</textarea>

    <button type="submit"><i class="fas fa-sync-alt"></i> ធ្វើបច្ចុប្បន្នភាពសសរ | Update Pile</button>
    <a href="{{ url_for('manage_piles') }}" class="cancel-button"><i class="fas fa-times-circle"></i> បោះបង់ | Cancel</a>
</form>

<h3>Transactions for this Pile | ប្រតិបត្តិការសម្រាប់សសរនេះ</h3>
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Type | ប្រភេទ</th>
            <th>Quantity | ចំនួន</th>
            <th>Site Name | ឈ្មោះការដ្ឋាន</th>
            <th>Date | កាលបរិច្ឆេទ</th>
            <th>Notes | កំណត់ចំណាំ</th>
            <th>Actions | សកម្មភាព</th>
        </tr>
    </thead>
    <tbody>
        {% for transaction in pile.transactions %}
        <tr>
            <td data-label="ID">{{ transaction.id }}</td>
            <td data-label="Type | ប្រភេទ" style="color: {{ 'red' if transaction.transaction_type == 'out' else 'green' }}; text-transform: uppercase;">
                {{ transaction.transaction_type }}
            </td>
            <td data-label="Quantity | ចំនួន">{{ transaction.quantity }}</td>
            <td data-label="Site Name | ឈ្មោះការដ្ឋាន">{{ transaction.customer_site.name if transaction.customer_site else 'N/A' }}</td>
            <td data-label="Date | កាលបរិច្ឆេទ">{{ transaction.transaction_date.strftime('%Y-%m-%d %H:%M') if transaction.transaction_date else 'N/A' }}</td>
            <td data-label="Notes | កំណត់ចំណាំ">{{ transaction.notes or 'N/A' }}</td>
            <td data-label="Actions | សកម្មភាព" class="actions">
                {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
                <form method="POST" action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" onsubmit="event.preventDefault(); showModal('Are you sure you want to delete this transaction? Stock will be adjusted. | ប្រាកដទេថាចង់លុបប្រតិបត្តិការនេះ? ស្តុកនឹងត្រូវបានកែតម្រូវ។', 'confirm', 'Confirm Deletion | បញ្ជាក់ការលុប', function(result) { if (result) this.closest('form').submit(); }.bind(this));">
                    <button type="submit" class="delete-button"><i class="fas fa-trash-alt"></i> លុប</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="7">No transactions for this pile yet. | មិនទាន់មានប្រតិបត្តិការសម្រាប់សសរនេះទេ។</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
