{% extends "base.html" %}

{% block title %}Manage Transactions | គ្រប់គ្រងប្រតិបត្តិការ{% endblock %}

{% block content %}
<h1>Manage Transactions | គ្រប់គ្រងប្រតិបត្តិការ</h1>

<div class="button-group">
    {% if current_user.is_authenticated and current_user.role in ['admin', 'manager', 'stock_keeper'] %}
        <a href="{{ url_for('add_transaction') }}" class="add-button"><i class="fas fa-plus-circle"></i> បន្ថែមប្រតិបត្តិការថ្មី | Add New Transaction</a>
    {% endif %}
</div>

<form method="GET" action="{{ url_for('manage_transactions') }}" class="filter-form">
    <span>
        <label for="search">ស្វែងរក | Search</label>
        <input type="text" id="search" name="search" placeholder="SKU, កំណត់ចំណាំ, ការដ្ឋាន..." value="{{ search_query or '' }}">
    </span>
    <span>
        <label for="transaction_type_filter">ប្រភេទ | Type</label>
        <select id="transaction_type_filter" name="transaction_type_filter">
            <option value="all">ទាំងអស់ | All</option>
            <option value="in" {% if selected_transaction_type == 'in' %}selected{% endif %}>ទទួល (In) | Received</option>
            <option value="out" {% if selected_transaction_type == 'out' %}selected{% endif %}>លក់ចេញ (Out) | Sold</option>
        </select>
    </span>
    <span>
        <label for="site_filter">ការដ្ឋាន | Site</label>
        <select id="site_filter" name="site_filter">
            <option value="all">ទាំងអស់ | All</option>
            {% for site in customer_sites %}
            <option value="{{ site.id }}" {% if selected_site_id|string == site.id|string %}selected{% endif %}>{{ site.name }}</option>
            {% endfor %}
        </select>
    </span>
    <span>
        <label for="start_date">ចាប់ពីថ្ងៃ | Start Date</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date or '' }}">
    </span>
    <span>
        <label for="end_date">ដល់ថ្ងៃ | End Date</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date or '' }}">
    </span>
    <button type="submit"><i class="fas fa-search"></i> ស្វែងរក | Search</button>
</form>

<div class="button-group">
    <button class="export-btn" onclick="exportTableToExcel('transactions-table', 'transactions_report')"><i class="fas fa-file-excel"></i> នាំចេញទៅ Excel | Export to Excel</button>
    <button class="export-btn" onclick="exportTableToPDF('transactions-table', 'Transactions Report')"><i class="fas fa-file-pdf"></i> នាំចេញទៅ PDF | Export to PDF</button>
</div>

<table id="transactions-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>កាលបរិច្ឆេទ | Date</th>
            <th>SKU សសរ | Pile SKU</th>
            <th>ប្រភេទ | Type</th>
            <th>បរិមាណ | Quantity</th>
            <th>ការដ្ឋាន | Site</th>
            <th>តម្លៃសរុប | Total Value</th>
            <th>កំណត់ចំណាំ | Notes</th>
            <th>សកម្មភាព | Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for transaction in transactions %}
        <tr>
            <td data-label="ID">{{ transaction.id }}</td>
            <td data-label="កាលបរិច្ឆេទ | Date">{{ transaction.transaction_date.strftime('%Y-%m-%d %H:%M') }}</td>
            <td data-label="SKU សសរ | Pile SKU">{{ transaction.pile.sku }}</td>
            <td data-label="ប្រភេទ | Type" style="color: {{ 'green' if transaction.transaction_type == 'in' else 'red' }}; font-weight: bold; text-transform: uppercase;">
                {{ transaction.transaction_type }}
            </td>
            <td data-label="បរិមាណ | Quantity">{{ transaction.quantity }}</td>
            <td data-label="ការដ្ឋាន | Site">{{ transaction.customer_site.name if transaction.customer_site else 'N/A' }}</td>
            <td data-label="តម្លៃសរុប | Total Value">${{ "%.2f"|format(transaction.total_value) if transaction.total_value is not none else '0.00' }}</td>
            <td data-label="កំណត់ចំណាំ | Notes">{{ transaction.notes or 'N/A' }}</td>
            <td data-label="សកម្មភាព | Actions" class="actions">
                {% if current_user.is_authenticated and current_user.role in ['admin', 'manager', 'stock_keeper'] %}
                    <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="edit-button"><i class="fas fa-edit"></i> កែ</a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
                    <form method="POST" action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" onsubmit="event.preventDefault(); showModal('Are you sure you want to delete this transaction? Stock will be adjusted. | ប្រាកដទេថាចង់លុបប្រតិបត្តិការនេះ? ស្តុកនឹងត្រូវបានកែតម្រូវឡើងវិញ។', 'confirm', 'Confirm Deletion | បញ្ជាក់ការលុប', function(result) { if (result) this.closest('form').submit(); }.bind(this));">
                        <button type="submit" class="delete-button"><i class="fas fa-trash-alt"></i> លុប</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="9">រកមិនឃើញប្រតិបត្តិការទេ។ | No transactions found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
