{% extends "base.html" %}

{% block title %}Manage Piles | គ្រប់គ្រងសសរ{% endblock %}

{% block content %}
<h1>Manage Piles | គ្រប់គ្រងសសរ</h1>

<div class="button-group">
    {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
    <a href="{{ url_for('add_pile') }}" class="add-button"><i class="fas fa-plus-circle"></i> បន្ថែមសសរថ្មី | Add New Pile</a>
    {% endif %}
    <button class="export-btn" onclick="exportTableToExcel('piles-table', 'piles_report')"><i class="fas fa-file-excel"></i> នាំចេញទៅ Excel | Export to Excel</button>
    <button class="export-btn" onclick="exportTableToPDF('piles-table', 'Piles Report')"><i class="fas fa-file-pdf"></i> នាំចេញទៅ PDF | Export to PDF</button>
</div>

<table id="piles-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>ប្រភេទសសរ | Pile Type</th>
            <th>ទំហំ | Size</th>
            <th>ប្រវែង (m) | Length (m)</th>
            <th>SKU</th>
            <th>ស្តុកបច្ចុប្បន្ន | Current Stock</th>
            <th>តម្លៃឯកតា | Unit Price</th>
            <th>ការពិពណ៌នា | Description</th>
            <th>បង្កើតនៅ | Created At</th>
            <th>សកម្មភាព | Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for pile in piles %}
        <tr>
            <td data-label="ID">{{ pile.id }}</td>
            <td data-label="ប្រភេទសសរ | Pile Type">{{ pile.pile_type }}</td>
            <td data-label="ទំហំ | Size">{{ pile.size }}</td>
            <td data-label="ប្រវែង (m) | Length (m)">{{ "%.2f"|format(pile.length) }}</td>
            <td data-label="SKU">{{ pile.sku }}</td>
            <td data-label="ស្តុកបច្ចុប្បន្ន | Current Stock">{{ pile.current_stock }}</td>
            <td data-label="តម្លៃឯកតា | Unit Price">${{ "%.2f"|format(pile.unit_price) if pile.unit_price is not none and pile.unit_price > 0 else 'N/A' }}</td>
            <td data-label="ការពិពណ៌នា | Description">{{ pile.description or 'N/A' }}</td>
            <td data-label="បង្កើតនៅ | Created At">{{ pile.created_at.strftime('%Y-%m-%d') if pile.created_at else 'N/A' }}</td>
            <td data-label="សកម្មភាព | Actions" class="actions">
                {% if current_user.is_authenticated and current_user.role in ['admin', 'manager'] %}
                <a href="{{ url_for('edit_pile', pile_id=pile.id) }}" class="edit-button"><i class="fas fa-edit"></i> កែ</a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <form method="POST" action="{{ url_for('delete_pile', pile_id=pile.id) }}" onsubmit="event.preventDefault(); showModal('Are you sure you want to delete this pile and all associated transactions? | ប្រាកដទេថាចង់លុបសសរនេះ និងប្រតិបត្តិការទាំងអស់ដែលពាក់ព័ន្ធ?', 'confirm', 'Confirm Deletion | បញ្ជាក់ការលុប', function(result) { if (result) this.closest('form').submit(); }.bind(this));">
                    <button type="submit" class="delete-button"><i class="fas fa-trash-alt"></i> លុប</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="10">រកមិនឃើញសសរទេ។ | No piles found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
    // Export functions are now in base.html, so no need to define them here.
    // Just ensure the onclick calls are correct.
</script>
{% endblock %}
